<!DOCTYPE html>
<html lang="en">
<head>
  <script src="env.js"></script>
  <meta charset="UTF-8" />
  <title>Villages Listing Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 0; padding: 1rem; background:#f5f5f5;}
    .card { background:white; padding:1rem 1.5rem; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.08); margin-bottom:1rem;}
    h1 { font-size:1.6rem; margin-bottom:0.5rem;}
    h2 { font-size:1.2rem; margin:0.5rem 0;}
    table { border-collapse: collapse; width:100%; margin-top:0.5rem;}
    th, td { border:1px solid #ddd; padding:0.4rem 0.6rem; font-size:0.85rem;}
    th { background:#fafafa; text-align:left;}
    .region-title { margin-top:0.8rem; font-weight:600;}
    button, a.button-link { padding:0.4rem 0.8rem; border-radius:6px; border:none; cursor:pointer; margin-right:0.4rem; font-size:0.9rem; text-decoration:none;}
    button { background:#2563eb; color:white;}
    a.button-link { background:white; border:1px solid #ccc; color:#111;}
    .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:0.8rem;}
    .meta { font-size:0.8rem; color:#555;}
  </style>
</head>
<body>
  <div class="card">
    <h1>Villages Listing Tracker</h1>
    <div class="meta" id="meta"></div>
    <div class="grid">
      <div class="card">
        <h2>Active</h2>
        <div id="active" style="font-size:2rem;">—</div>
      </div>
      <div class="card">
        <h2>Pending</h2>
        <div id="pending" style="font-size:2rem;">—</div>
      </div>
    </div>
    <div style="margin-top:0.8rem;">
      <button onclick="runCount()">Run Count</button>
      <a class="button-link" id="csvLink" href="#" target="_blank">Export CSV</a>
    </div>
  </div>

  <div class="card">
    <h2>By Region &amp; Village</h2>
    <div id="regions"></div>
  </div>

  <div class="card">
    <h2>History (last 30 runs)</h2>
    <table id="historyTable">
      <thead>
        <tr><th>Run At (UTC)</th><th>Active</th><th>Pending</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const API = (window.API_BASE || "http://localhost:8000");

    async function fetchLatest() {
      const r = await fetch(API + "/latest");
      const j = await r.json();
      if (!j || !j.run_at) return;
      document.getElementById("meta").textContent = "Last run: " + j.run_at;
      document.getElementById("active").textContent = j.total_active;
      document.getElementById("pending").textContent = j.total_pending;
      document.getElementById("csvLink").href = API + "/export.csv";

      const regionsDiv = document.getElementById("regions");
      regionsDiv.innerHTML = "";
      const grouped = j.grouped || {};
      Object.keys(grouped).sort().forEach(region => {
        const regDiv = document.createElement("div");
        regDiv.className = "region";
        const title = document.createElement("div");
        title.className = "region-title";
        title.textContent = region;
        regDiv.appendChild(title);

        const table = document.createElement("table");
        const thead = document.createElement("thead");
        thead.innerHTML = "<tr><th>Village</th><th>Active</th><th>Pending</th><th>Total</th></tr>";
        table.appendChild(thead);
        const tbody = document.createElement("tbody");

        const villages = grouped[region] || {};
        Object.keys(villages).sort().forEach(village => {
          const row = document.createElement("tr");
          const v = villages[village];
          row.innerHTML = "<td>" + village + "</td><td>" + v.active + "</td><td>" + v.pending + "</td><td>" + v.total + "</td>";
          tbody.appendChild(row);
        });

        table.appendChild(tbody);
        regDiv.appendChild(table);
        regionsDiv.appendChild(regDiv);
      });
    }

    async function runCount() {
        await fetch(API + "/run", {method: "POST"});
        setTimeout(() => { fetchLatest(); }, 5000);
    }

    async function fetchLatest() {
        const r = await fetch(API + "/count");
        const j = await r.json();
        document.querySelector("#latest").innerHTML = j.total_listings_rows;
    }
    
    async function fetchHistory() {
        const tbody = document.querySelector("#historyTable tbody");
        tbody.innerHTML = "<tr><td colspan='3'>History not implemented in new backend</td></tr>";
    }
    
  </script>
</body>
</html>
